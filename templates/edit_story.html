{% extends "layout.html" %}

{% block title %}Edit Story{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <h1 class="mb-4">Edit Story</h1>
    
    <div id="loading-container" class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    
    <form id="edit-story-form" style="display: none;">
      <div class="mb-3">
        <label for="title" class="form-label">Title</label>
        <input type="text" class="form-control" id="title" name="title" required>
      </div>
      <div class="mb-3">
        <label for="content" class="form-label">Content</label>
        <textarea class="form-control" id="content" name="content" rows="15" required></textarea>
      </div>
      <div class="d-flex justify-content-between">
        <a href="#" id="cancel-btn" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">Update Story</button>
      </div>
    </form>
    
    <div id="error-container" class="alert alert-danger mt-3" style="display: none;"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let storyId;
  let originalStory;
  
  document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    
    // Get story ID from URL
    storyId = window.location.pathname.split('/').pop();
    
    // Fetch story details
    fetchStoryDetails(storyId);
    
    // Set up form submission
    const editStoryForm = document.getElementById('edit-story-form');
    editStoryForm.addEventListener('submit', updateStory);
    
    // Set up cancel button
    document.getElementById('cancel-btn').addEventListener('click', function(e) {
      e.preventDefault();
      if (hasChanges()) {
        if (confirm('You have unsaved changes. Are you sure you want to leave?')) {
          window.location.href = `/story/${storyId}`;
        }
      } else {
        window.location.href = `/story/${storyId}`;
      }
    });
  });
  
  function checkAuthentication() {
    const currentUser = getCurrentUser();
    if (!currentUser) {
      window.location.href = '/login';
    }
  }
  
  function fetchStoryDetails(id) {
    fetch(`/api/story/${id}`, {
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        if (response.status === 404) {
          throw new Error('Story not found');
        }
        throw new Error('Failed to fetch story details');
      }
      return response.json();
    })
    .then(story => {
      originalStory = story;
      checkAuthorization(story);
      populateForm(story);
    })
    .catch(error => {
      console.error('Error fetching story:', error);
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('error-container').textContent = error.message;
      document.getElementById('error-container').style.display = 'block';
    });
  }
  
  function checkAuthorization(story) {
    const currentUser = getCurrentUser();
    if (currentUser.id !== story.author_id) {
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('error-container').textContent = 'You are not authorized to edit this story';
      document.getElementById('error-container').style.display = 'block';
      throw new Error('Not authorized');
    }
  }
  
  function populateForm(story) {
    document.getElementById('title').value = story.title;
    document.getElementById('content').value = story.content;
    
    document.getElementById('loading-container').style.display = 'none';
    document.getElementById('edit-story-form').style.display = 'block';
  }
  
  function hasChanges() {
    const currentTitle = document.getElementById('title').value.trim();
    const currentContent = document.getElementById('content').value.trim();
    
    return currentTitle !== originalStory.title || currentContent !== originalStory.content;
  }
  
  function updateStory(e) {
    e.preventDefault();
    
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title || !content) {
      showAlert('Please fill in all fields', 'warning');
      return;
    }
    
    if (!hasChanges()) {
      showAlert('No changes detected', 'info');
      return;
    }
    
    const storyData = {
      title: title,
      content: content
    };
    
    fetch(`/api/story/${storyId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(storyData),
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/login';
          throw new Error('Authentication required');
        }
        if (response.status === 403) {
          throw new Error('You are not authorized to edit this story');
        }
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to update story');
        });
      }
      return response.json();
    })
    .then(data => {
      showAlert('Story updated successfully!', 'success');
      setTimeout(() => {
        window.location.href = `/story/${storyId}`;
      }, 1000);
    })
    .catch(error => {
      console.error('Error updating story:', error);
      if (error.message !== 'Authentication required') {
        showAlert(error.message, 'danger');
      }
    });
  }
</script>
{% endblock %}