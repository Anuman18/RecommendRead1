{% extends "layout.html" %}

{% block title %}Story Details{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <div id="story-container">
      <div class="text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
    
    <div class="mt-4">
      <a href="/stories" class="btn btn-secondary">Back to Stories</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get story ID from URL
    const storyId = window.location.pathname.split('/').pop();
    fetchStoryDetails(storyId);
  });
  
  function fetchStoryDetails(storyId) {
    fetch(`/api/story/${storyId}`, {
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Story not found');
      }
      return response.json();
    })
    .then(story => {
      displayStoryDetails(story);
      checkIfBookmarked(story.id);
    })
    .catch(error => {
      console.error('Error fetching story:', error);
      document.getElementById('story-container').innerHTML = `
        <div class="alert alert-danger">
          <h4 class="alert-heading">Error!</h4>
          <p>${error.message || 'Failed to load story details'}</p>
        </div>
      `;
    });
  }
  
  function displayStoryDetails(story) {
    const container = document.getElementById('story-container');
    
    const storyDetails = document.createElement('div');
    storyDetails.className = 'story-details';
    
    // Title and author section
    const header = document.createElement('div');
    header.className = 'mb-4';
    
    const title = document.createElement('h1');
    title.className = 'mb-2';
    title.textContent = story.title;
    
    const authorDate = document.createElement('div');
    authorDate.className = 'd-flex justify-content-between align-items-center mb-4';
    
    const author = document.createElement('h5');
    author.className = 'text-muted mb-0';
    author.textContent = `By ${story.author_username}`;
    
    const date = document.createElement('small');
    date.className = 'text-muted';
    date.textContent = new Date(story.created_at).toLocaleDateString();
    
    authorDate.appendChild(author);
    authorDate.appendChild(date);
    
    header.appendChild(title);
    header.appendChild(authorDate);
    
    // Action buttons
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'd-flex justify-content-end mb-4';
    
    const currentUser = getCurrentUser();
    
    // Only show edit/delete if user is the author
    if (currentUser && currentUser.id === story.author_id) {
      const editButton = document.createElement('a');
      editButton.href = `/edit-story/${story.id}`;
      editButton.className = 'btn btn-outline-primary me-2';
      editButton.textContent = 'Edit';
      
      const deleteButton = document.createElement('button');
      deleteButton.className = 'btn btn-outline-danger';
      deleteButton.textContent = 'Delete';
      deleteButton.onclick = function() {
        deleteStory(story.id);
      };
      
      actionsDiv.appendChild(editButton);
      actionsDiv.appendChild(deleteButton);
    }
    
    // Add bookmark button for authenticated users
    if (currentUser) {
      const bookmarkButton = document.createElement('button');
      bookmarkButton.id = 'bookmark-btn';
      bookmarkButton.className = 'btn btn-outline-secondary ms-2';
      bookmarkButton.innerHTML = '<i class="bi bi-bookmark"></i> Bookmark';
      bookmarkButton.onclick = function() {
        toggleBookmark(story.id);
      };
      
      actionsDiv.appendChild(bookmarkButton);
    }
    
    // Content section
    const contentDiv = document.createElement('div');
    contentDiv.className = 'story-content mt-4 p-4 border rounded';
    contentDiv.style.whiteSpace = 'pre-line';
    contentDiv.textContent = story.content;
    
    // Append all sections
    storyDetails.appendChild(header);
    storyDetails.appendChild(actionsDiv);
    storyDetails.appendChild(contentDiv);
    
    container.innerHTML = '';
    container.appendChild(storyDetails);
  }
  
  function checkIfBookmarked(storyId) {
    const currentUser = getCurrentUser();
    if (!currentUser) return;
    
    fetch('/api/bookmarks', {
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to fetch bookmarks');
      }
      return response.json();
    })
    .then(data => {
      const bookmarkBtn = document.getElementById('bookmark-btn');
      if (!bookmarkBtn) return;
      
      const bookmarked = data.bookmarks.some(bookmark => bookmark.id === storyId);
      if (bookmarked) {
        bookmarkBtn.classList.remove('btn-outline-secondary');
        bookmarkBtn.classList.add('btn-secondary');
        bookmarkBtn.innerHTML = '<i class="bi bi-bookmark-fill"></i> Bookmarked';
      }
    })
    .catch(error => {
      console.error('Error checking bookmarks:', error);
    });
  }
  
  function toggleBookmark(storyId) {
    const bookmarkBtn = document.getElementById('bookmark-btn');
    const isBookmarked = bookmarkBtn.classList.contains('btn-secondary');
    
    const url = `/api/bookmark/${storyId}`;
    const method = isBookmarked ? 'DELETE' : 'POST';
    
    fetch(url, {
      method: method,
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to update bookmark');
      }
      return response.json();
    })
    .then(data => {
      if (isBookmarked) {
        bookmarkBtn.classList.remove('btn-secondary');
        bookmarkBtn.classList.add('btn-outline-secondary');
        bookmarkBtn.innerHTML = '<i class="bi bi-bookmark"></i> Bookmark';
        showAlert('Bookmark removed', 'info');
      } else {
        bookmarkBtn.classList.remove('btn-outline-secondary');
        bookmarkBtn.classList.add('btn-secondary');
        bookmarkBtn.innerHTML = '<i class="bi bi-bookmark-fill"></i> Bookmarked';
        showAlert('Story bookmarked', 'success');
      }
    })
    .catch(error => {
      console.error('Error updating bookmark:', error);
      showAlert('Failed to update bookmark', 'danger');
    });
  }
  
  function deleteStory(storyId) {
    if (!confirm('Are you sure you want to delete this story? This action cannot be undone.')) {
      return;
    }
    
    fetch(`/api/story/${storyId}`, {
      method: 'DELETE',
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to delete story');
      }
      return response.json();
    })
    .then(data => {
      showAlert('Story deleted successfully', 'success');
      setTimeout(() => {
        window.location.href = '/stories';
      }, 1000);
    })
    .catch(error => {
      console.error('Error deleting story:', error);
      showAlert('Failed to delete story', 'danger');
    });
  }
</script>
{% endblock %}